<!DOCTYPE HTML>
<html lang="ko" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>nextauth tutorial - TIL</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">
        <link rel="stylesheet" href="../theme/pagetoc.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">TIL</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div class="content-wrap">
                            <h1 id="nextauth-íŠœí† ë¦¬ì–¼"><a class="header" href="#nextauth-íŠœí† ë¦¬ì–¼">nextauth íŠœí† ë¦¬ì–¼</a></h1>
<ul>
<li>next.js ë²„ì „: 15.3.52</li>
<li>nextauth ë²„ì „ 4.24.11</li>
<li>postgresql ë²„ì „: 17.4</li>
<li>pg ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „: 8.15.6</li>
<li>ì‘ì„±: 2025. 5. 8.</li>
<li>stuo githubì— ì½”ë“œ ì˜¬ë¦¼.</li>
</ul>
<h2 id="podman-ì„¤ì •"><a class="header" href="#podman-ì„¤ì •">podman ì„¤ì •</a></h2>
<h3 id="postgresql-ì´ë¯¸ì§€-ë‹¤ìš´ë¡œë“œ"><a class="header" href="#postgresql-ì´ë¯¸ì§€-ë‹¤ìš´ë¡œë“œ">postgresql ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</a></h3>
<pre><code class="language-ps">PS E:\&gt; podman search postgres
NAME                                DESCRIPTION
docker.io/library/postgres          The PostgreSQL object-relational database sy...


PS E:\&gt; podman pull docker.io/library/postgres
Trying to pull docker.io/library/postgres:latest...
Getting image source signatures
</code></pre>
<h3 id="postgresql-ì‹¤í–‰"><a class="header" href="#postgresql-ì‹¤í–‰">postgresql ì‹¤í–‰</a></h3>
<pre><code class="language-ps">-- ë„¤íŠ¸ì›Œí¬ ì„¤ì •
podman network create --subnet=172.31.0.0/16 mynet

-- ì‹¤í–‰
podman run -d --net mynet --ip 172.31.0.7 --name postgres -p 43432:5432 -p 43022:22 -e POSTGRES_PASSWORD=My:s3Cr3t/ -e TZ=Asia/Seoul docker.io/library/postgres:latest
</code></pre>
<h2 id="db-ì„¤ì •"><a class="header" href="#db-ì„¤ì •">DB ì„¤ì •</a></h2>
<pre><code class="language-sql">-- user ìƒì„±ì€ ìƒëµ

root@31dfb447326c:/# su - postgres


postgres@31dfb447326c:~$ psql 
psql (17.4 (Debian 17.4-1.pgdg120+2))
Type "help" for help.


postgres=# create user scott password 'tiger';
CREATE ROLE


postgres=# create database nextauth owner=scott LC_COLLATE='C.utf8' LC_CTYPE='C.utf8' template=template0;
CREATE DATABASE


postgres=# exit


postgres@31dfb447326c:~$ psql -U scott -d nextauth
psql (17.4 (Debian 17.4-1.pgdg120+2))
Type "help" for help.


nextauth=&gt; create table member
(
    id varchar(10) primary key
    , nickname varchar(10) not null
    , pwd varchar(62) not null
    , email varchar(100)
);
CREATE TABLE


-- crypt extension ìƒì„±. ë¡œê·¸ì¸ ìœ„í•´
nextauth=&gt; create extension pgcrypto;
CREATE EXTENSION


-- member í•˜ë‚˜ ì¶”ê°€
nextauth=&gt; insert into member(id, nickname, pwd, email) values 
('user01', 'nickname01', crypt('1234', gen_salt('bf')), 'test@gmail.com');
INSERT 0 1



-- data í…Œì´ë¸” ì¶”ê°€í•˜ê³  ë°ì´í„° 2ê°œ ì¶”ê°€. session í…ŒìŠ¤íŠ¸ ìœ„í•´.
nextauth=&gt; create table data (id int primary key, title varchar(100) not null);
CREATE TABLE
nextauth=&gt; insert into data (id, title) values (1, 'about next.js');
INSERT 0 1
nextauth=&gt; insert into data (id, title) values (2, 'about react');
INSERT 0 1
</code></pre>
<h2 id="nextjs-í”„ë¡œì íŠ¸-ìƒì„±"><a class="header" href="#nextjs-í”„ë¡œì íŠ¸-ìƒì„±">next.js í”„ë¡œì íŠ¸ ìƒì„±</a></h2>
<h3 id="í”„ë¡œì íŠ¸-ìƒì„±"><a class="header" href="#í”„ë¡œì íŠ¸-ìƒì„±">í”„ë¡œì íŠ¸ ìƒì„±</a></h3>
<pre><code class="language-ps">npx create-next-app
âˆš What is your project named? ... nextauth
âˆš Would you like to use TypeScript? ... No / Yes
âˆš Would you like to use ESLint? ... No / Yes
âˆš Would you like to use Tailwind CSS? ... No / Yes
âˆš Would you like your code inside a `src/` directory? ... No / Yes
âˆš Would you like to use App Router? (recommended) ... No / Yes
âˆš Would you like to use Turbopack for `next dev`? ... No / Yes
âˆš Would you like to customize the import alias (`@/*` by default)? ... No / Yes
Creating a new Next.js app in D:\test\nextauth001\src\nextauth.

Using npm.

Initializing project with template: app-tw


Installing dependencies:
- react
- react-dom
- next

Installing devDependencies:
- typescript
- @types/node
- @types/react
- @types/react-dom
- @tailwindcss/postcss
- tailwindcss
- eslint
- eslint-config-next
- @eslint/eslintrc


added 436 packages, and audited 437 packages in 54s

165 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
Success! Created nextauth at D:\test\nextauth001\src\nextauth
</code></pre>
<h3 id="nextauthjs-ì„¤ì¹˜"><a class="header" href="#nextauthjs-ì„¤ì¹˜">nextauth.js ì„¤ì¹˜</a></h3>
<pre><code class="language-ps">PS D:\test\nextauth001\src\nextauth&gt; npm install next-auth

added 14 packages, and audited 451 packages in 9s

169 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

PS D:\test\nextauth001\src\nextauth&gt; npm list next-auth
nextauth@0.1.0 D:\test\nextauth001\src\nextauth
â””â”€â”€ next-auth@4.24.11
</code></pre>
<h3 id="pg-íŒ¨í‚¤ì§€-ì„¤ì¹˜"><a class="header" href="#pg-íŒ¨í‚¤ì§€-ì„¤ì¹˜">pg íŒ¨í‚¤ì§€ ì„¤ì¹˜</a></h3>
<pre><code class="language-ps">PS D:\test\nextauth001\src\nextauth&gt; npm install pg

added 14 packages, and audited 465 packages in 3s

169 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
PS D:\test\nextauth001\src\nextauth&gt; npm list pg
nextauth@0.1.0 D:\test\nextauth001\src\nextauth
â””â”€â”¬ pg@8.15.6
  â””â”€â”¬ pg-pool@3.9.6
    â””â”€â”€ pg@8.15.6 deduped

PS D:\test\nextauth001\src\nextauth&gt; npm install --save @types/pg

added 9 packages, and audited 474 packages in 2s

169 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
</code></pre>
<h2 id="í…ŒìŠ¤íŠ¸-ì‹¤í–‰"><a class="header" href="#í…ŒìŠ¤íŠ¸-ì‹¤í–‰">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</a></h2>
<p>í”„ë¡œì íŠ¸ í´ë”ì—ì„œ</p>
<pre><code>npm run dev
</code></pre>
<p><img src="img/20250509093037.png" alt="" /></p>
<h3 id="apppagetsx-ìˆ˜ì •"><a class="header" href="#apppagetsx-ìˆ˜ì •">app/page.tsx ìˆ˜ì •</a></h3>
<p>ì‹¸ê·¸ë¦¬ ì§€ìš°ê³  ì•„ë˜ë§Œ ë‚¨ê¸´ë‹¤.</p>
<pre><code class="language-ts">export default function Home() {
  return (
    &lt;div&gt;
      nextauth
    &lt;/div&gt;
  );
}
</code></pre>
<p><img src="img/20250509093258.png" alt="" /></p>
<h2 id="nextjsì—ì„œ-pg-ì ‘ì†"><a class="header" href="#nextjsì—ì„œ-pg-ì ‘ì†">next.jsì—ì„œ pg ì ‘ì†</a></h2>
<h3 id="applibdbts"><a class="header" href="#applibdbts">app/lib/db.ts</a></h3>
<p>dbê´€ë ¨ ì²˜ë¦¬ë¥¼ ëª¨ë‘ ë‹´ë‹¹í•  í´ë˜ìŠ¤ ìƒì„±</p>
<h4 id="pg-ì‚¬ìš©"><a class="header" href="#pg-ì‚¬ìš©">pg ì‚¬ìš©</a></h4>
<pre><code class="language-ts">// app/lib/db.ts

import pg, { Client } from 'pg'
</code></pre>
<h4 id="ì¸í„°í˜ì´ìŠ¤-ìƒì„±"><a class="header" href="#ì¸í„°í˜ì´ìŠ¤-ìƒì„±">ì¸í„°í˜ì´ìŠ¤ ìƒì„±</a></h4>
<p>DB í…Œì´ë¸”(member) êµ¬ì¡°ì™€ ë˜‘ê°™ì´ ë§Œë“ ë‹¤.<br />
ë‹¤ë§Œ pwdëŠ” ê°€ì ¸ì™€ ì“¸ ì¼ì´ ì—†ìœ¼ë‹ˆ ëºë‹¤.</p>
<pre><code class="language-ts">//app/lib/db.ts

// ì¸í„°í˜ì´ìŠ¤ ìƒì„±
export interface SMember
{
    id: string;
    nickname: string;        
    email: string  | null;
}
</code></pre>
<h4 id="í´ë˜ìŠ¤-ë³¸ì²´"><a class="header" href="#í´ë˜ìŠ¤-ë³¸ì²´">í´ë˜ìŠ¤ ë³¸ì²´</a></h4>
<pre><code class="language-ts">class DBMan
{    
    private client: pg.Client;

    constructor()
    {
        this.client = new Client(
            {
                user: 'scott', 
                password: 'tiger',
                host: 'localhost',
                port: 43432,
                database: 'nextauth'
            }
        );

        this.client.connect()
            .then( ()=&gt; {
                console.log("connect ì„±ê³µ");
            })
            .catch( () =&gt; {
                console.log("connect ì‹¤íŒ¨");
            });
    }


     // ë©¤ë²„ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    public async getMembers()
    {
        const sql = `
            select * from member
            `;
        
        const result = await this.client.query(sql);
  
        const data = result.rows;
        console.log("[db.ts getMembers] result.rows = ", data);

        return data;
    }


    // ì—°ê²°ì„ ëŠëŠ”ë‹¤.
    public async disconnect()
    {
        this.client.end();        
    }
}

export default DBMan;
</code></pre>
<h4 id="db-ì ‘ì†-ë°ì´í„°-ê°€ì ¸ì˜¤ê¸°-í…ŒìŠ¤íŠ¸"><a class="header" href="#db-ì ‘ì†-ë°ì´í„°-ê°€ì ¸ì˜¤ê¸°-í…ŒìŠ¤íŠ¸">DB ì ‘ì†, ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í…ŒìŠ¤íŠ¸</a></h4>
<p>app/lib/page.tsx íŒŒì¼ ìƒì„±</p>
<p>ê°€ì¥ ê°„ë‹¨í•˜ê²Œ DB í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•</p>
<pre><code class="language-ts">// app/lib/page.tsx íŒŒì¼
// db ì—°ê²° í…ŒìŠ¤íŠ¸ ìœ„í•œ ì„œë²„ ì»´í¼ë„ŒíŠ¸

import DBMan, { SMember } from '@/app/lib/db';

export default async function DBTest() {
    const db = new DBMan();
    const members: Array&lt;SMember&gt; = await db.getMembers();
    db.disconnect();
  
    members.forEach(element =&gt; {
      console.log(element.nickname);    
    });
  
    return (
      &lt;div&gt;
        member í…Œì´ë¸” ë°ì´í„° ê°¯ìˆ˜: {members.length}
      &lt;/div&gt;
    );
}
</code></pre>
<p>ì‹¤í–‰ê²°ê³¼: localhost:3000/<strong>lib</strong> ë¡œ ì ‘ì†</p>
<p><img src="img/20250509101540.png" alt="" /></p>
<p>vscode í„°ë¯¸ë„ì— ì¶œë ¥ëœ ì½˜ì†” ë‚´ìš©</p>
<pre><code class="language-ps"> GET /lib 200 in 141ms
 GET /favicon.ico?favicon.45db1c09.ico 200 in 304ms
 âœ“ Compiled in 55ms
 âœ“ Compiled /lib in 52ms
connect ì„±ê³µ
[db.ts getMembers] result.rows =  [
  {
    id: 'user01',
    nickname: 'nickname01',
    pwd: '$2a$06--------------------------------ê°€ë¦¼----------------',
    email: 'test@gmail.com'
  }
]
nickname01
 GET /lib 200 in 177ms
 GET /favicon.ico?favicon.45db1c09.ico 200 in 287ms
</code></pre>
<p>DB ì ‘ì† ì‰½ê²Œ ì˜ ë˜ëŠ” ê²ƒ í™•ì¸</p>
<h2 id="nextauthë¥¼-ì´ìš©í•œ-ë¡œê·¸ì¸"><a class="header" href="#nextauthë¥¼-ì´ìš©í•œ-ë¡œê·¸ì¸">nextauthë¥¼ ì´ìš©í•œ ë¡œê·¸ì¸</a></h2>
<p>credentials (ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸)ë¡œ ë¡œê·¸ì¸</p>
<h3 id="appapiauthnextauthroutets"><a class="header" href="#appapiauthnextauthroutets">app/api/auth/[â€¦nextauth]/route.ts</a></h3>
<p>nextauthì—ì„œ ê°€ì¥ ì¤‘ì‹¬ì´ ë˜ëŠ” íŒŒì¼.</p>
<p>ì‹¤ì œ í´ë”ëª…ì´ <code>[...nextauth]</code> ì´ë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts

import NextAuth from 'next-auth/next'
import CredentialsProvider from 'next-auth/providers/credentials'

const handler = NextAuth({
    providers: [
      CredentialsProvider({
        name: 'Credentials',
        credentials: {
          username: { label: 'ì•„ì´ë””', type: 'text', placeholder: 'ì•„ì´ë”” ì…ë ¥' },
          password: { label: 'ë¹„ë°€ë²ˆí˜¸', type: 'password', placeholder: 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥' },
        },
  
        async authorize(credentials, req) {
          return null;  // nullì„ ë„˜ê¸°ë©´ ì‹¤íŒ¨í–ˆë‹¤ëŠ” ëœ»ì´ë‹¤. 
        },
      }),
    ]
  })
  
export { handler as GET, handler as POST }
</code></pre>
<p>ìœ„ ì½”ë“œê°€ nextauthì—ì„œ credentials ë°©ì‹ì„ ì‚¬ìš©í•  ë•Œ ê°€ì¥ ê°„ë‹¨í•œ í˜•íƒœì´ë‹¤.</p>
<p>ì´ ì½”ë“œëŠ” get ë°©ì‹ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  POST ë°©ì‹ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë°”ë¡œ í…ŒìŠ¤íŠ¸í•´ë³¼ ìˆ˜ëŠ” ì—†ë‹¤.</p>
<p><img src="img/20250509103426.png" alt="" /></p>
<p>ë¡œê·¸ì¸ ë²„íŠ¼ì„ ë§Œë“¤ê³  ëˆ„ë¥´ë©´ ë¡œê·¸ì¸ì´ ì‹¤í–‰ë˜ë„ë¡ í•˜ì.</p>
<h3 id="ë¡œê·¸ì¸-ë²„íŠ¼"><a class="header" href="#ë¡œê·¸ì¸-ë²„íŠ¼">ë¡œê·¸ì¸ ë²„íŠ¼</a></h3>
<p>app/page.tsx íŒŒì¼ì— ë¡œê·¸ì¸ ë²„íŠ¼ ì¶”ê°€</p>
<pre><code class="language-ts">// app/page.tsx

import { signIn } from "next-auth/react";

export default function Home() {
  return (
    &lt;div&gt;
      nextauth

      {/* ë¡œê·¸ì¸ ë²„íŠ¼ ì¶”ê°€ */}
      &lt;button onClick={() =&gt; signIn()}&gt;ë¡œê·¸ì¸&lt;/button&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<p><img src="img/20250509104905.png" alt="" /></p>
<p>ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê·¸ì— ëŒ€í•œ ì´ë²¤íŠ¸ í•¸ë“¤ë§ì„ í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— Client componentì—ì„œë§Œ ì´ ë™ì‘ì´ ê°€ëŠ¥í•˜ë‹¤. ê·¸ëŸ¬ë‹ˆ app/page.tsxëŠ” ì›ë˜ëŒ€ë¡œ ëŒë ¤ ë†“ê³  ë¡œê·¸ì¸ ë²„íŠ¼ì„ ê°€ì§€ëŠ” client componentë¥¼ ë§Œë“¤ì.</p>
<p>(ë¬¼ë¡  page.tsx íŒŒì¼ ë§¨ ìœ„ì— â€œuse clientâ€œë¥¼ ì ìœ¼ë©´ ê°€ì¥ ê°„ë‹¨í•˜ê²Œ í•´ê²°ë˜ì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ëŠ” ì»´í¼ë„ŒíŠ¸ë¡œ ë§Œë“¤ì–´ ì¶”ê°€í•´ ì“°ì.)</p>
<pre><code class="language-ts">// app/page.tsx

export default function Home() {
  return (
    &lt;div&gt;
      nextauth
    &lt;/div&gt;
  );
}
</code></pre>
<p>app/<strong>login</strong>/<strong>sign_in_button_c.tsx</strong> ì»´í¼ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì.</p>
<p>íŒŒì¼ëª… ë§¨ ë’¤ì— _c ë¥¼ ë¶™ì¸ ê±´ ì´ê²Œ client ì»´í¼ë„ŒíŠ¸ë¼ êµ¬ë¶„í•˜ê¸° ìœ„í•´ì„œë‹¤.</p>
<p>nextauthì—ì„œëŠ” loginì„ signin ì´ë¼ ë¶€ë¥¸ë‹¤. logoutì€ signout. ê·¸ë˜ì„œ ë”°ë¼í•˜ê¸°ë¡œ í–ˆë‹¤.</p>
<pre><code class="language-ts">// app/login/sign_in_button_c.tsx

"use client";
import React from "react";
import { signIn } from "next-auth/react";

export default function SignInButton_C() {
  return (    
        &lt;div&gt;
            &lt;button onClick={() =&gt; signIn()}&gt;ë¡œê·¸ì¸&lt;/button&gt;
        &lt;/div&gt;
  );
}
</code></pre>
<p>ì´ì œ ì´ ì»´í¼ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ app/page.tsxë¥¼ ìˆ˜ì •í•˜ì.</p>
<pre><code class="language-ts">// app/page.tsx

import SignInButton_C from "./login/sign_in_button_c";

export default function Home() {
  return (
    &lt;div&gt;
      nextauth

      &lt;SignInButton_C /&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<p><img src="img/20250509111049.png" alt="" /></p>
<p>ë¡œê·¸ì¸ ë²„íŠ¼ì— CSSë¥¼ ì£¼ì§€ ì•Šì•˜ë”ë‹ˆ(í˜„ì¬ tailwind ì ìš© ìƒíƒœ) ê·¸ëƒ¥ í…ìŠ¤íŠ¸ì²˜ëŸ¼ ë³´ì´ëŠ”ë° ì½”ë“œë¥¼ ë‹¨ìˆœí™”í•˜ê¸° ìœ„í•´ css ë¨¹ì´ì§€ ì•Šê² ìŒ.</p>
<p>ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì•„ë˜ì™€ ê°™ì´ nextauthê°€ ì œê³µí•˜ëŠ” ê¸°ë³¸ ë¡œê·¸ì¸ ì°½ì´ ë‚˜ì˜¨ë‹¤.</p>
<p><img src="img/20250509111205.png" alt="" /></p>
<p><img src="img/20250509111308.png" alt="" /></p>
<p>ì•„ì´ë”” ë¹„ë²ˆ ëª¨ë‘ 111ì„ ë„£ê³  [Sign in with Credentials] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´,</p>
<p><img src="img/20250509111322.png" alt="" /></p>
<p>ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆë‹¤ëŠ” ë©”ì‹œì§€ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.</p>
<p>ì´ê±° ì „ë¶€ nextauthê°€ ê¸°ë³¸ì ìœ¼ë¡œ í•´ì£¼ëŠ” ê±°ë‹¤.</p>
<h3 id="dbë¥¼-ì´ìš©í•œ-ì§„ì§œ-ë¡œê·¸ì¸"><a class="header" href="#dbë¥¼-ì´ìš©í•œ-ì§„ì§œ-ë¡œê·¸ì¸">DBë¥¼ ì´ìš©í•œ ì§„ì§œ ë¡œê·¸ì¸</a></h3>
<p>app/api/auth/[â€¦nextauth]/route.ts íŒŒì¼ì„ ë‹¤ì‹œ ì—´ì–´ë³´ì.</p>
<p>authorize() í•¨ìˆ˜ì—ì„œ ì–´ë–¤ ê°’ì„ ë¦¬í„´í•˜ë©´ ë¡œê·¸ì¸ ì„±ê³µì´ê³  nullì„ ë¦¬í„´í•˜ë©´ ë¡œê·¸ì¸ ì‹¤íŒ¨ë‹¤. ë¦¬í„´í•˜ëŠ” ê°’ì€ ë‚˜ì¤‘ì— ì„¸ì…˜ì„ êµ¬ì„±í•  ë•Œ ì“°ì´ë‹ˆ ì•„ë¬´ ê°’ì´ë‚˜ ë¦¬í„´í•˜ë©´ ì•ˆ ëœë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts 

async authorize(credentials, req) {
          return null;  // nullì„ ë„˜ê¸°ë©´ ì‹¤íŒ¨í–ˆë‹¤ëŠ” ëœ»ì´ë‹¤. 
        },
</code></pre>
<p>ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•  ê±°ë‹¤.</p>
<p>ì´ê±¸ í•˜ë ¤ë©´ ë¨¼ì € DBMan í´ë˜ìŠ¤ì—ì„œ loginì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ê°€ ìˆì–´ì•¼ í•œë‹¤.</p>
<pre><code class="language-ts">// app/lib/db.ts

    // ë¡œê·¸ì¸. ê²°ê³¼ê°€ nullì´ë©´ ë¡œê·¸ì¸ ì‹¤íŒ¨. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸ ì„±ê³µ
    public async login(id: string, password: string)
    {
        let sql = `
                select 
                    id
                    , nickname
                    , email
                from 
                    member
                where
                    id = '${id}'
                    and pwd = crypt('${password}', pwd)
                    `;

        const result = await this.client.query(sql);
        const rowcount = result?.rowCount || -1;
        
        if (1 == rowcount)
        {
            const data = result.rows[0];
            return data;        
        }

        return null;
    }
</code></pre>
<p>cryptë¥¼ ì´ìš©í•´ insert í–ˆìœ¼ë‹ˆ, cryptë¥¼ ì´ìš©í•´ whereë¬¸ì„ ë§Œë“¤ì–´ì•¼ í•œë‹¤.</p>
<pre><code class="language-sql"> where pwd = crypt('${password}', pwd)
</code></pre>
<p>ì™€ ê°™ì€ ì‹ìœ¼ë¡œ where ì ˆì„ êµ¬ì„±í•˜ë©´ ëœë‹¤.</p>
<p>ì´ì œ DBëŠ” ì¤€ë¹„ê°€ ë˜ì—ˆìœ¼ë‹ˆ authorize í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì.</p>
<p>app/api/auth/[â€¦nextauth]/route.ts íŒŒì¼ì˜ ìœ—ë¶€ë¶„ì—</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts 

import DBMan, { SMember } from '@/app/lib/db';
</code></pre>
<p>ì„ ì¶”ê°€í•´ DBë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì¤€ë¹„í•˜ê³ ,</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts 

          async authorize(credentials, req) {
            const db = new DBMan();
            // console.log("credentials?.username", credentials?.username || "");
            // console.log("credentials?.password", credentials?.password || "");
            const member: SMember = await db.login(credentials?.username || "", credentials?.password || "")
            db.disconnect();
    
            console.log("[login] member: ", member);       
            
            if (member != null)
            {
              console.log("[login]ë¡œê·¸ì¸ ì„±ê³µ. member: ", member);       
              return member;    // ë¡œê·¸ì¸ ì„±ê³µ
            }
            else          
            {
              console.log("[login] ë¡œê·¸ì¸ ì‹¤íŒ¨: ", credentials?.username);
              return null;  // ë¡œê·¸ì¸ ì‹¤íŒ¨
            }
        },
</code></pre>
<p>user01 / 1234 ë¡œ ë¡œê·¸ì¸í•´ ë³´ì. í‹€ë¦¬ê²Œë„ í•´ë³´ì.</p>
<p>ì‹¤íŒ¨í•œ ê²½ìš° ë¡œê·¸</p>
<pre><code class="language-ps">connect ì„±ê³µ
[login] member:  null
[login] ë¡œê·¸ì¸ ì‹¤íŒ¨:  user01
 POST /api/auth/callback/credentials 302 in 110ms
 GET /api/auth/error?error=CredentialsSignin&amp;provider=credentials 302 in 83ms
 GET /api/auth/signin?error=CredentialsSignin 200 in 79ms
 GET /favicon.ico 200 in 308ms
</code></pre>
<p>ì„±ê³µí•œ ê²½ìš° ë¡œê·¸</p>
<pre><code class="language-ps">connect ì„±ê³µ
[login] member:  { id: 'user01', nickname: 'nickname01', email: 'test@gmail.com' }
[login]ë¡œê·¸ì¸ ì„±ê³µ. member:  { id: 'user01', nickname: 'nickname01', email: 'test@gmail.com' }
 POST /api/auth/callback/credentials 302 in 108ms
 GET / 200 in 147ms
 GET /favicon.ico?favicon.45db1c09.ico 200 in 314ms
</code></pre>
<h3 id="custom-ë¡œê·¸ì¸-í™”ë©´"><a class="header" href="#custom-ë¡œê·¸ì¸-í™”ë©´">custom ë¡œê·¸ì¸ í™”ë©´</a></h3>
<p>ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” ë“± ì¢€ ë” ë‹¤ì–‘í•œ ë¡œê·¸ì¸ ê´€ë ¨ ì²˜ë¦¬ë¥¼ í•˜ë ¤ë©´ ì•„ë¬´ë˜ë„ custom ë¡œê·¸ì¸ í™”ë©´ì´ ìˆì–´ì•¼ í•œë‹¤. nextauthê°€ ë§Œë“¤ì–´ì„œ ë³´ì—¬ì£¼ëŠ” ë¡œê·¸ì¸ í™”ë©´ì„ ê·¸ëŒ€ë¡œ ì“°ëŠ” ê²½ìš°ëŠ” ì—†ì„ê±°ë‹¤.</p>
<p>ì´ë¥¼ ìœ„í•´</p>
<p>app/api/auth/[â€¦nextauth]/route.ts íŒŒì¼ì—ì„œ NextAuth() íŒŒë¼ë¯¸í„°ë¡œ pages ë¥¼ ì¶”ê°€í•´ ì£¼ë©´ ëœë‹¤.</p>
<p>providers: ë°‘ì— pages: ë¥¼ ì¶”ê°€í•´ ì£¼ê³  signIn() í•¨ìˆ˜ê°€ í˜¸ì¶œë  ë•Œ ì´ë™í•  í˜ì´ì§€ë¥¼ ì ì–´ì¤€ë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts

    , pages: {
        signIn: '/auth/signin', // Displays signin buttons
        // signOut: '/auth/signout', // Displays form with sign out button
        // error: '/auth/error', // Error code passed in query string as ?error=
        // verifyRequest: '/auth/verify-request', // (used for check email message)
        // newUser: null, // Will disable the new account creation screen
      }
</code></pre>
<p>ë°‘ì— ì—¬ëŸ¬ ì¢…ë¥˜ê°€ ìˆì§€ë§Œ ì¼ë‹¨ signInë§Œ í•´ë³´ì.</p>
<p>ì—¬ê¸°ê¹Œì§€ë§Œ í•˜ê³  ë‹¤ì‹œ [ë¡œê·¸ì¸] ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ë©´</p>
<p><img src="img/20250509132111.png" alt="" /></p>
<p>ì•„ê¹Œì™€ ë‹¬ë¦¬ NOT FOUND ì—ëŸ¬ê°€ ë‚œë‹¤.</p>
<p>app/api/auth/signin ìœ¼ë¡œ ì°¾ì•„ê°€ì•¼ í•˜ëŠ”ë° ê·¸ëŸ° í´ë”ê°€ ì—†ì–´ì„œë‹¤.</p>
<p>ì´ì œ ì„¤ì •í•œ ê²ƒì²˜ëŸ¼ app/api/auth/signin í´ë”ë¥¼ ë§Œë“¤ì. ì •í™•í•œ ìœ„ì¹˜ì— í´ë”ê°€ ë§Œë“¤ì–´ì§€ì§€ ì•Šìœ¼ë©´ dev ì„œë²„ê°€ ì£½ê¸°ë„ í•œë‹¤.</p>
<p>ê·¸ë¦¬ê³  ê·¸ í´ë” ì•„ë˜ì— page.tsx íŒŒì¼ì„ ë§Œë“ ë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/signin/page.tsx

'use client'
import React, { useRef } from 'react'
import { signIn } from 'next-auth/react'


export default function LoginForm_C() {
    const useridRef = useRef(null)
    const passwordRef = useRef(null)

    const handleSubmit = async () =&gt; {
        //console.log(useridRef.current)
        //console.log(passwordRef.current)

        const result = await signIn('credentials', {
            username: useridRef.current,
            password: passwordRef.current,
            redirect: false,
            callbackUrl: '/',        
        });

        console.log("[Login] result", result);
        
        if (result?.ok == false) 
        {
          location.href = '/';          
        }
        else
        {
          alert("ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

  return (    
        &lt;div&gt;
          &lt;label&gt;ì•„ì´ë””&lt;/label&gt;&lt;input ref={useridRef} onChange={(e: any) =&gt; {useridRef.current = e.target.value}} id='id' name='id' type='text' required autoFocus={true} /&gt;
          &lt;label&gt;ë¹„ë°€ë²ˆí˜¸&lt;/label&gt;&lt;input ref={passwordRef} onChange={(e: any) =&gt; {passwordRef.current = e.target.value}} id='password' name='password' type='password' required /&gt;
          
          &lt;button onClick={handleSubmit}&gt;ë¡œê·¸ì¸&lt;/button&gt;
        &lt;/div&gt;
  )
}
</code></pre>
<p>ì´ì œ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <code>app/api/auth/signin/page.tsx</code> íŒŒì¼ì˜ ë‚´ìš©ì´ ë³´ì—¬ì§„ë‹¤.</p>
<p><img src="img/20250509133454.png" alt="" /></p>
<p>ì—­ì‹œë‚˜ css ë•Œë¬¸ì— input box ì˜ í…Œë‘ë¦¬ê°€ ì•ˆ ê·¸ë ¤ì§€ê³  ìˆë‹¤.</p>
<p><img src="img/20250509143333.png" alt="" /></p>
<p>ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ <code>/</code>ë¡œ ì´ë™í•˜ê³ , ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ë©”ì‹œì§€ê°€ ë‚˜ì˜¨ë‹¤.</p>
<p><img src="img/20250509133752.png" alt="" /></p>
<p>signIn() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ ë‹¤ì–‘í•œ íŒŒë¼ë¯¸í„°ë¥¼ ë„˜ê¸°ëŠ”ë°, ê·¸ ì¤‘ redirectë¥¼ trueë¡œ ì„¸íŒ…í•˜ë©´, ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ê·¸ ìë¦¬ì— ê°€ë§Œíˆ ìˆê³ , ì„±ê³µí•˜ë©´ callbackUrl ì—ì„œ ì •í•´ì¤€ ìœ„ì¹˜ë¡œ ì´ë™í•˜ê²Œ ëœë‹¤.</p>
<p>ë­”ê°€ ë‹¤ë¥¸ ì˜µì…˜ì„ ì¢€ ë” ì°¾ì•„ë³¼ í•„ìš”ê°€ ìˆê² ë‹¤.</p>
<p>í•˜ì§€ë§Œ ì¼ë‹¨ì€ ë‚´ê°€ ì›í•˜ëŠ”ëŒ€ë¡œ ì¡°ì •í•˜ë ¤ë©´ redirectë¥¼ falseë¡œ ë†“ê³  ê·¸ ì•„ë˜ì—ì„œ ê²°ê³¼ì— ë”°ë¼ (await í•˜ë‹ˆê¹Œ) ê·¸ì— ë§ëŠ” ì²˜ë¦¬ë¥¼ í•´ì£¼ì—ˆë‹¤.</p>
<h2 id="ì„¸ì…˜-ì²˜ë¦¬"><a class="header" href="#ì„¸ì…˜-ì²˜ë¦¬">ì„¸ì…˜ ì²˜ë¦¬</a></h2>
<p>nextauthëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸í•œ ê²°ê³¼ë¥¼ ì„¸ì…˜ì— ë„£ì–´ì£¼ê³  JWT(JSON Web Token) ê°’ê¹Œì§€ ë§Œë“¤ì–´ì¤€ë‹¤. ì•„ë¬´ ê²ƒë„ ì•ˆí•´ë„ ì„¸ì…˜ì— ê°’ì´ ì´ë¯¸ ë“¤ì–´ê°€ ìˆëŠ”ê±°ë‹¤.</p>
<p>ë§Œì•½ ì„¸ì…˜ì— ì €ì¥ë˜ëŠ” ê°’ì„ (ë‹¹ì—°í•˜ê²Œë„) ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ <code>app/api/auth/[...nextauth]/route.ts</code> íŒŒì¼ì—ì„œ ì´ë²ˆì—ëŠ” callbacks: ë¥¼ ì¶”ê°€í•´ì•¼ í•œë‹¤.</p>
<p>nextauthëŠ” 2ê°œì˜ callbacksë¥¼ ì œê³µí•œë‹¤.</p>
<ul>
<li>jwt() : <a href="./nextauth.html#jwt-%EC%BD%9C%EB%B0%B1-%ED%95%A8%EC%88%98">jws callback</a> ì°¸ì¡°</li>
<li>session() : <a href="./nextauth.html#session-%EC%BD%9C%EB%B0%B1-%ED%95%A8%EC%88%98">session callback</a> ì°¸ì¡°</li>
</ul>
<p>pages ë°‘ì— callbacks: ë¥¼ ì¶”ê°€í•´ ë³´ì.</p>
<h3 id="jwt-ì½œë°±"><a class="header" href="#jwt-ì½œë°±">jwt() ì½œë°±</a></h3>
<p>ìš°ì„  jwt()ë¥¼ ì¶”ê°€í•œë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/signin/page.tsx

    , callbacks: 
    {
        jwt({ token, user }) 
        {
          console.log("\n\n");
          console.log("------------------- [jwt callback] -------------------");
          console.log("[jwt] token = ", token, "\n");
          console.log("[jwt] user = ", user);
                    
          return token;
        }
    }
</code></pre>
<p>ì´ë ‡ê²Œ í•´ ë†“ê³  ë¡œê·¸ì¸ì„ í•´ë³´ì.
jwt()ëŠ” JWTê°€ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰ë˜ëŠ”ë°, authorize() í•¨ìˆ˜ì—ì„œ ê°’ì´ ë¦¬í„´ë˜ë©´ ì´ ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ë°”ë¡œ JWTë¥¼ ë§Œë“¤ê¸° ë•Œë¬¸ì— ì´ jwt() ì½œë°±í•¨ìˆ˜ë„ ì‹¤í–‰ëœë‹¤.</p>
<p>ì´ë ‡ê²Œ ë†“ê³  ë¡œê·¸ì¸ì´ ì„±ê³µí•˜ë©´ jwt()ë¡œ ë„˜ì–´ì˜¤ëŠ” ê°’ì´ ì–´ë–¤ ê°’ë“¤ì¸ì§€ vscodeì˜ terminalì— ì¶œë ¥ëœ ë¡œê·¸ë¡œ í™•ì¸í•˜ì.</p>
<pre><code class="language-ps">------------------- [jwt callback] -------------------
[jwt] token =  {
  name: undefined,
  email: 'test@gmail.com',
  picture: undefined,
  sub: 'user01'
}

[jwt] user =  { id: 'user01', nickname: 'nickname01', email: 'test@gmail.com' } 
</code></pre>
<p>tokenì„ ê°€ë§Œ ë³´ë©´, member ê°ì²´ê°€ ê°€ì§€ê³  ìˆëŠ” ê²ƒ ì¤‘ tokenì´ ê¸°ì¡´ì— ê°€ì§€ê³  ìˆë˜ í•­ëª©  ì¤‘ í•˜ë‚˜ì¸ email í•­ëª©ì— ìë™ìœ¼ë¡œ ë“¤ì–´ì™€ ìˆëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  <code>sub</code> í•­ëª©(subject)ì— id ê°’ì¸ â€™user01â€™ì´ ë“¤ì–´ê°€ ìˆëŠ” ê²ƒë„ ë³¼ ìˆ˜ ìˆë‹¤.</p>
<p>nicknameì€ tokenì˜ ê¸°ì¡´ í•­ëª©ì— ì—†ëŠ” í•­ëª©ì´ë¼ ì•„ë¬´ ë°ì—ë„ ë“¤ì–´ê°€ ìˆì§€ ì•Šë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/signin/page.tsx

if (member != null)
{
  console.log("[login]ë¡œê·¸ì¸ ì„±ê³µ. member: ", member);       
  return member;    // ë¡œê·¸ì¸ ì„±ê³µ
}
</code></pre>
<p>ìœ„ì™€ ê°™ì´ authorize() í•¨ìˆ˜ ë‚´ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì´ë ‡ê²Œ ë¦¬í„´í•œ member ê°ì²´ê°€ jwt() í•¨ìˆ˜ì˜ user ê°ì²´ë¡œ ê·¸ëŒ€ë¡œ ë“¤ì–´ì™€ ìˆë‹¤.</p>
<p>ì—¬ê¸°ì„œ ì“¸ ê°’ì€ tokenì´ë‹ˆê¹Œ tokenì— userì˜ ê°’ì„ ì˜®ê²¨ë‹´ê³  ê¸°íƒ€ ë” í•„ìš”í•œ ê²Œ ìˆìœ¼ë©´ tokenì— ì ì–´ì£¼ë©´ ëœë‹¤.</p>
<p>jwt() í•¨ìˆ˜ë¥¼ ì•„ë˜ì²˜ëŸ¼ ì¡°ê¸ˆ ë” ê³ ì³¤ë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/signin/page.tsx

    , callbacks: 
    {
        jwt({ token, user }) 
        {
            console.log("\n\n");
            console.log("------------------- [jwt callback] -------------------");
            console.log("[jwt] token = ", token, "\n");
            console.log("[jwt] user = ", user);

            if (user) 
            {
                token.id = user.id;
                token.nickname = user.nickname;
                token.email = user.email;
            }
            
            return token;
        }
    }
</code></pre>
<p>vscodeì—ì„œ userì—ëŠ” nicknameì´ë¼ëŠ” ê°’ì´ ì—†ë‹¤ê³  ì•„ë˜ì²˜ëŸ¼ ë¹¨ê°„ ë°‘ì¤„ì„ ë³´ì—¬ ì¤„ê±°ë‹¤. ë‹¹ì¥ì€ í° ì—ëŸ¬ê°€ ë‚˜ì§€ëŠ” ì•Šìœ¼ë‹ˆ ì´ ë¬¸ì œëŠ” <a href="nextauth_001.html#sessionuser%EC%9D%98-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EA%B5%AC%EC%A1%B0-%EB%B3%80%EA%B2%BD">ë‚˜ì¤‘ì— í•´ê²°</a> í•˜ì.</p>
<p><img src="img/20250509141949.png" alt="" /></p>
<p>ì—¬ê¸°ê¹Œì§€ ë¡œê·¸ì¸í•˜ëŠ” ìˆœê°„ nextauthê°€ JWT ê°’ì„ ìƒì„±í•˜ê³ , ê·¸ë˜ì„œ ê·¸ ë•Œ jwt() í•¨ìˆ˜ê°€ ì½œë°±ë˜ì–´ tokenì— ê°’ì„ ì“¸ ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.</p>
<p>ì´ ê°’ì€ nextauthê°€ ì˜ ë³´ê´€í•˜ê³  ìˆë‹¤.</p>
<h3 id="session-ì½œë°±"><a class="header" href="#session-ì½œë°±">session() ì½œë°±</a></h3>
<p>ì´ì œ nextauthê°€ ê°€ì§€ê³  ìˆë˜ í† í° ê°’ì„ ì‚¬ìš©í•  ë–„ê°€ ë˜ì—ˆë‹¤. ì‚¬ìš©ìê°€ sessionì— ì €ì¥ëœ ê°’ì„ ì›í•˜ë©´ ê·¸ ë•Œ session() ì½œë°±ì´ ì¼ì–´ë‚œë‹¤.</p>
<p>êµ¬ì²´ì ìœ¼ë¡œëŠ” client componentê°€ useSession í›…ì„ ì´ìš©í•˜ê±°ë‚˜ server componentê°€ getServerSession() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ë•Œë‹¤.</p>
<p>jwt() í•¨ìˆ˜ì—ì„œ tokenì— ê°’ì´ ì˜ ë“¤ì–´ê°”ëŠ”ì§€, ì •í™•íˆëŠ” ì–´ë–¤ ê°’ì´ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œë¼ë„ session() ì½œë°± í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ë³´ì.</p>
<p>callbacks: ì•ˆì— jwt() í•¨ìˆ˜ ì•„ë˜ì— session() í•¨ìˆ˜ë¥¼ ì¶”ê°€í•œë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/signin/page.tsx

, async session({ session, token }) 
{
  console.log("\n\n");
  console.log("------------------- [session] -------------------");
  console.log("[session] session = ", session);
  console.log("[session] token = ", token);
  
  return session;
}
</code></pre>
<p>ì´ë ‡ê²Œ ì¶”ê°€í•˜ê³  ë¡œê·¸ì¸ì„ í•´ë„ session() í•¨ìˆ˜ ì½œë°±ì€ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤. (ë¡œê·¸ì— ì•„ë¬´ê²ƒë„ ì•ˆë‚˜ì˜¨ë‹¤) ì•„ë¬´ë°ì„œë„ ì„¸ì…˜ì„ ì´ìš©í•˜ì§€ ì•Šê³  ìˆìœ¼ë‹ˆê¹Œ.</p>
<p>ì´ì œ nextauthì—ì„œ ì œê³µí•˜ëŠ” ì„¸ì…˜ì„ ì´ìš©í•´ ë³´ì.</p>
<h3 id="nextauth-session"><a class="header" href="#nextauth-session">nextauth session</a></h3>
<p>app/login/sign_in_button_c.tsx íŒŒì¼ì„ ìˆ˜ì •í•˜ì. session ê°’ì„ í™•ì¸í•´ì„œ ë¡œê·¸ì¸ ëœ ìƒíƒœë©´ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ë³´ì—¬ì£¼ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ë³´ì—¬ì£¼ë„ë¡ ê³ ì¹˜ë ¤ í•œë‹¤. ê·¸ë¦¬ê³  ë¡œê·¸ì¸ ë˜ì–´ ìˆëŠ” ìƒíƒœë©´ nicknameë„ ë³´ì—¬ì£¼ì.</p>
<p>reactì˜ useSession í›…ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ê¸° ìœ„í•´ client componentì—¬ì•¼ í•œë‹¤. ìš°ë¦¬ëŠ” ì´ ì»´í¼ë„ŒíŠ¸ë¥¼ client ì»´í¼ë„ŒíŠ¸ë¡œ ë§Œë“¤ì—ˆì—ˆë‹¤.</p>
<p>import ë¶€ë¶„ì„ ì´ë ‡ê²Œ ë°”ê¾¼ë‹¤.</p>
<pre><code class="language-ts">// app/login/sign_in_button_c.tsx

import { signIn, signOut, useSession } from "next-auth/react";
</code></pre>
<p>app/login/sign_in_button_c.tsx íŒŒì¼ì˜ ì „ì²´ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<pre><code class="language-ts">// app/login/sign_in_button_c.tsx

"use client";
import React from "react";
import { signIn, signOut, useSession } from "next-auth/react";

export default function SignInButton_C() {
  const { data: session } = useSession();

  if (session &amp;&amp; session.user)
  {
      return (
          &lt;span onClick={() =&gt; signOut()}&gt;{session.user.nickname}ë‹˜ ë¡œê·¸ì•„ì›ƒ&lt;/span&gt;
      );
  }
  else
  {
    return (
          &lt;span onClick={() =&gt; signIn()}&gt;ë¡œê·¸ì¸&lt;/span&gt;
    );
  }    
}
</code></pre>
<p>ì—¬ê¸°ê¹Œì§€ ìˆ˜ì •í•˜ê³  <code>/</code> í˜ì´ì§€ë¡œ ê°€ë©´(http://localhost:3000)</p>
<p><img src="img/20250509144332.png" alt="" /></p>
<p>useSession ì“¸ êº¼ë©´ &lt;SessionProvider&gt; ë¡œ ê°ì‹¸ì•¼ í•œë‹¨ë‹¤.</p>
<p>ê·¸ëŸ¼ Providerë¥¼ ë§Œë“¤ì–´ ë³´ì.</p>
<p>app/login/providers.tsx íŒŒì¼ì„ ìƒì„±í•˜ì.</p>
<pre><code class="language-ts">// app/login/providers.tsx

"use client";

import { SessionProvider } from "next-auth/react";
import React, { ReactNode } from "react";

interface Props 
{
  children: ReactNode;
}

export default function Providers({ children }: Props) 
{
  return (
    &lt;SessionProvider&gt;{children}&lt;/SessionProvider&gt;
  );
}
</code></pre>
<p>ê·¸ëƒ¥ {children}ì„ &lt;SessionProvider&gt;ë¡œ ê°ì‹¸ê¸°ë§Œ í•œë‹¤.</p>
<p>ì´ì œ ìš°ë¦¬ì˜ SingInButton_C ì»´í¼ë„ŒíŠ¸ë¥¼ ê°ì‹¸ê¸° ìœ„í•´ app/page.tsx íŒŒì¼ì„ ìˆ˜ì •í•˜ì.</p>
<pre><code class="language-ts">// app/page.tsx

import Providers from "./login/providers";
import SignInButton_C from "./login/sign_in_button_c";

export default function Home() {
  return (
    &lt;div&gt;
      nextauth
      &lt;Providers&gt;
        &lt;SignInButton_C /&gt;
      &lt;/Providers&gt;
    &lt;/div&gt;
  );
}
</code></pre>
<p>ì„¸ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  ê³³ì´ ê°ì‹¸ì§€ë„ë¡ í•´ì•¼ í•œë‹¤. ê·¸ë˜ì„œ ëŒ€ë¶€ë¶„ &lt;Providers&gt; ì»´í¼ë„ŒíŠ¸ë¥¼ return ë¬¸ì˜ ë§¨ ìœ„ì™€ ì•„ë˜ì—ì„œ ì‚¬ìš©í•œë‹¤.</p>
<p>ë§Œì•½ providersë¥¼ server componentë¡œ ë§Œë“¤ë©´(ë§¨ ìœ„ì— â€œuse clientâ€; í•˜ì§€ ì•Šìœ¼ë©´) ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ë¥¼ ë³´ê²Œ ëœë‹¤.</p>
<p><img src="img/20250509145043.png" alt="" /></p>
<p>ì—¬ê¸°ê¹Œì§€ ì§„í–‰í•˜ë©´,</p>
<p><img src="img/20250509145211.png" alt="" /></p>
<p>ì´ë ‡ê²Œ ë‚˜ì˜¨ë‹¤.</p>
<p><code>session.user.nickname</code> ë¶€ë¶„ì— ê°’ì´ ë‚˜ì˜¤ì§€ ì•Šë‹¤ëŠ” ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.</p>
<p>ì´ì œ ë‹¤ì‹œ vscode í„°ë¯¸ë„ì˜ ë¡œê·¸ ê°’ì„ í™•ì¸í•´ ë³´ì.</p>
<pre><code class="language-ps">------------------- [jwt callback] -------------------
[jwt] token =  {
  email: 'test@gmail.com',
  sub: 'user01',
  id: 'user01',
  nickname: 'nickname01',
  iat: 1746768710,
  exp: 1749360710,
  jti: '02e24704-ae76-4333-b8ee-163d5dbcde40'
}

[jwt] user =  undefined



------------------- [session] -------------------
[session] session =  {
  user: { name: undefined, email: 'test@gmail.com', image: undefined },
  expires: '2025-06-08T05:50:56.023Z'
}
[session] token =  {
  email: 'test@gmail.com',
  sub: 'user01',
  id: 'user01',
  nickname: 'nickname01',
  iat: 1746768710,
  exp: 1749360710,
  jti: '02e24704-ae76-4333-b8ee-163d5dbcde40'
}
</code></pre>
<p>ë¡œê·¸ì¸í•  ë•Œë§ˆë‹¤ jwt() í•¨ìˆ˜ê°€ ì½œë°±ë˜ì–´ ë¡œê·¸ì— ë‚˜ì™”ê³ , ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ <code>/</code>ë¡œ ê°€ë„ë¡ í–ˆëŠ”ë° ê·¸ëŸ¼ app/page.tsxë¥¼ í˜¸ì¶œí•œ ê±°ê³ , ê±°ê¸°ì„œ useSession í›…ì„ ì‚¬ìš©í•˜ë‹ˆ session() í•¨ìˆ˜ê°€ ì½œë°±ë˜ì—ˆë‹¤. ê·¸ë˜ì„œ ì„¸ì…˜ ë¡œê·¸ê°€ ë‚¨ì€ ê²ƒ.</p>
<p>ì´ ë¡œê·¸ë¥¼ ìì„¸íˆ ë³´ë©´ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ tokenì—ëŠ” jwt() í•¨ìˆ˜ ì½œë°±ë•Œ ì ì€ ê°’ì´ ê·¸ëŒ€ë¡œ ìˆê³ , session.userëŠ” ì²˜ìŒ ë¡œê·¸ì¸í–ˆì„ ë•Œ ë´¤ë˜ ê²ƒê³¼ ê°™ì€ ìƒíƒœë¼ëŠ” ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.</p>
<p>ê·¸ë¦¬ê³  í•œ ê°€ì§€ ë” ì•Œ ìˆ˜ ìˆëŠ” ê±´ tokenì— jti(JWT ID)ì— ê°’ì´ ë“¤ì–´ê°€ ìˆë‹¤ëŠ” ê±°ë‹¤. ì´ëŠ” JWTë¥¼ êµ¬ë¶„í•˜ëŠ”ë° ì‚¬ìš©ëœë‹¤. ë§Œì•½ ì´ìƒí•œ í–‰ë™ì„ í•˜ëŠ” ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ ì´ jtië¥¼ ë„˜ê¸°ëŠ” ì‚¬ìš©ìëŠ”(ì‚¬ìš©ì íŠ¹ì •) ë” ì´ìƒ ì•„ë¬´ ê²ƒë„ í•˜ì§€ ëª»í•˜ê²Œ ë§‰ì„ ìˆ˜ë„ ìˆë‹¤.</p>
<p>ëˆ„êµ°ê°€ session ê°’ì„ ìš”êµ¬í•˜ë©´ í™”ë©´ì— ë³´ì—¬ì¤„ ë‚´ìš©ë“¤ë§Œ session.userì— ë‹´ì•„ ì£¼ì. ë³´ì•ˆì„ ìœ„í•´.</p>
<p>ì´ì œ app/login/sign_in_button_c.tsx íŒŒì¼ì—ì„œ <code>session.user.nickname</code> ê°’ì´ ë³´ì´ì§€ ì•Šì•˜ë˜ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ ê±° ê°™ë‹¤.</p>
<pre><code class="language-ts">, async session({ session, token }) 
{
  console.log("\n\n");
  console.log("------------------- [session] -------------------");
  console.log("[session] session = ", session);
  console.log("[session] token = ", token);

  session.user = {
    id : token.id as string,
    nickname: token.nickname as string,
  };
  
  return session;
}
</code></pre>
<p>ì´ë ‡ê²Œ session.user ê°’ì„ ì¬ì„¤ì •í•´ì£¼ë©´ ë¡œê·¸ì¸í•œ ì‚¬ëŒì˜ nicknameì„ ì œëŒ€ë¡œ ë³´ì—¬ì¤€ë‹¤.</p>
<p><img src="img/20250509152900.png" alt="" /></p>
<p>ìŒ.. í™”ë©´ ë³´ì—¬ì§€ëŠ” ë¶€ë¶„ì„ ìµœì†Œí™”í•˜ë ¤ë‹ˆ ì´ëŸ° ì°¸ì‚¬ê°€.</p>
<p>ì•”íŠ¼ ì—¬ê¸°ê¹Œì§€ ì„¸ì…˜ê°’ì— ë”°ë¼ ë¡œê·¸ì¸ê³¼ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì´ ë‚˜ì˜¤ëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>
<h2 id="ë¡œê·¸ì¸í•œ-ì‚¬ëŒë§Œ-ë³¼-ìˆ˜-ìˆëŠ”-í˜ì´ì§€"><a class="header" href="#ë¡œê·¸ì¸í•œ-ì‚¬ëŒë§Œ-ë³¼-ìˆ˜-ìˆëŠ”-í˜ì´ì§€">ë¡œê·¸ì¸í•œ ì‚¬ëŒë§Œ ë³¼ ìˆ˜ ìˆëŠ” í˜ì´ì§€</a></h2>
<p>ë¡œê·¸ì¸í•œ ì‚¬ëŒë§Œ ë³¼ ìˆ˜ ìˆëŠ” í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ ë³´ê² ë‹¤. ë¨¼ì € Restful API ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ê³  ê±°ê¸°ì— ì œí•œì„ ê±¸ì–´ë³´ë ¤ í•œë‹¤.</p>
<h3 id="api-ì„œë¹„ìŠ¤-ë§Œë“¤ê¸°"><a class="header" href="#api-ì„œë¹„ìŠ¤-ë§Œë“¤ê¸°">API ì„œë¹„ìŠ¤ ë§Œë“¤ê¸°</a></h3>
<p>data í…Œì´ë¸”ì˜ ê°’ì„ ì½ì–´ì„œ ë³´ì—¬ì£¼ëŠ” ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ì–´ ë³´ì.</p>
<p>ë¨¼ì € DBì—ì„œ data í…Œì´ë¸”ì˜ ê°’ì„ ëª¨ë‘ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤. DBMan í´ë˜ìŠ¤ë¥¼ ìˆ˜ì •í•˜ì.</p>
<pre><code class="language-ts">// app/lib/db.ts

    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    public async getData()
    {
        const sql = `
            select * from data
            `;
        
        const result = await this.client.query(sql);
  
        const data = result.rows;
        console.log("[db.ts getData] result.rows = ", data);

        return data;
    }
</code></pre>
<p>ìœ„ì™€ ê°™ì´ DBMan í´ë˜ìŠ¤ì— í•¨ìˆ˜ë¥¼ ì¶”ê°€í•œë‹¤.</p>
<p>ë‹¤ìŒìœ¼ë¡œ app/api/data/route.ts íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ì.</p>
<pre><code class="language-ts">// app/api/data/route.ts

import { NextRequest, NextResponse } from 'next/server';
import DBMan from '@/app/lib/db';

export async function GET(req: NextRequest) 
{  
  const db = new DBMan();
  const data = await db.getData();
  db.disconnect();

  return NextResponse.json(data);
}
</code></pre>
<p>data í…Œì´ë¸”ì˜ ëª¨ë“  ë‚´ìš©ì„ ë³´ì—¬ì£¼ëŠ” restful ì„œë¹„ìŠ¤ë‹¤.</p>
<p><img src="img/20250509154304.png" alt="" /></p>
<p>data í…Œì´ë¸”ì˜ ëª¨ë“  ë‚´ìš©ì„ json í˜•íƒœë¡œ ë¦¬í„´í•´ì¤€ë‹¤.</p>
<pre><code class="language-json">[{"id":1,"title":"about next.js"},{"id":2,"title":"about react"}]
</code></pre>
<p>ì´ ì„œë¹„ìŠ¤ì˜ ë¬¸ì œëŠ” ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ë„ ì•„ë¬´ë‚˜ ì´ ì‚¬ì´íŠ¸ì— ì ‘ì†í•´ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤ëŠ” ê±°ë‹¤. ì´ì œ ì—¬ê¸°ì— ë¡œê·¸ì¸í•œ ì‚¬ëŒë§Œ ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆë„ë¡ ìˆ˜ì •í•´ ë³´ì.</p>
<p>route.tsëŠ” ì„œë²„ ì»´í¼ë„ŒíŠ¸ë‹ˆê¹Œ useSessionì´ ì•„ë‹ˆë¼ getServerSession() í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì•¼ í•œë‹¤.</p>
<p>app/api/data/route.ts íŒŒì¼ì„ ìˆ˜ì •í•´ ë³´ì.</p>
<pre><code class="language-ts">import { NextRequest, NextResponse } from 'next/server';
import DBMan from '@/app/lib/db';

import { getServerSession } from 'next-auth';

export async function GET(req: NextRequest) 
{  
    const session = await getServerSession();
    console.log("\n\n[data/route.ts] session = ", session, "\n");

    const db = new DBMan();
    const data = await db.getData();
    db.disconnect();

    return NextResponse.json(data);
}
</code></pre>
<p>ì´ë ‡ê²Œ í•˜ê³  ë¡œê·¸ì¸ í•œ ë‹¤ìŒ</p>
<p><code>http://localhost:3000/api/data</code> ì— ì ‘ì†í•˜ë©´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì•„ë¬´ ë¬¸ì œê°€ ì—†ëŠ” ê±° ê°™ì€ë° vscode ì˜ í„°ë¯¸ë„ì— ë‚˜ì˜¨ ë¡œê·¸ëŠ” ë‚œë¦¬ê°€ ë‚¬ë‹¤.</p>
<pre><code class="language-ps">[next-auth][error][JWT_SESSION_ERROR] 
https://next-auth.js.org/errors#jwt_session_error decryption operation failed {
  message: 'decryption operation failed',
  stack: 'JWEDecryptionFailed: decryption operation failed\n' +
    '    at gcmDecrypt (D:\\test\\nextauth001\\src\\nextauth\\.next\\server\\chunks\\node_modules_jose_dist_node_cjs_b4a80197._.js:769:15)\n' 

    ... 20ì¤„ ì •ë„ ë‚˜ì˜¨ ê±° ì‚­ì œí•¨.
    
  name: 'JWEDecryptionFailed'
}


[data/route.ts] session =  null
</code></pre>
<p>ìš°ì„  ì œì¼ ì²˜ìŒ ë“œëŠ” ìƒê°ì€ ì•„.. &lt;Proders&gt; ë¥¼ page.tsxê°€ ì•„ë‹ˆë¼ layout.tsxì—ì„œ ì‚¬ìš©í•´ì•¼ ê² êµ¬ë‚˜. ì˜€ì§€ë§Œ ì¼ë‹¨ ê·¸ ë¬¸ì œëŠ” ì•„ë‹Œê±° ê°™ë‹¤.</p>
<p>getServerSession() í•¨ìˆ˜ëŠ” ì¤‘ìš”í•œ ì¸ìë¥¼ í•˜ë‚˜ ë°›ëŠ”ë‹¤. ì—¬íƒœ í´ë¼ì´ì–¸íŠ¸ ì»´í¼ë„ŒíŠ¸ì—ì„œ useSession í›…ì„ ì‚¬ìš©í•  ë•ŒëŠ” í° ë¬¸ì œì—†ì´ ì“¸ ìˆ˜ ìˆì„ ì¤„ ì•Œì•˜ëŠ”ë° ì„œë²„ ì»´í¼ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” nextauthë¥¼ ì¢€ ë” ì œëŒ€ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤. getServerSession() í•¨ìˆ˜ì— authOptions ì¸ìë¥¼ ì¶”ê°€í•˜ë©´ì„œ nextauthë¥¼ ì¢€ ë” ì œëŒ€ë¡œ, ë³´ì•ˆì„ ê°•í™”í•´ ê°€ë©° ì‚¬ìš©í•´ ë³´ì.</p>
<p>ì—¬íƒœ ìš°ë¦¬ëŠ” app/api/auth/[â€¦nextauth]/route.ts íŒŒì¼ì—ì„œ NextAuth() í•¨ìˆ˜ì— ë³µì¡í•œ ê°’ì„ íŒŒë¼ë¯¸í„°ë¡œ ë˜ì ¸ì¤¬ë‹¤.</p>
<p>getServerSession() í•¨ìˆ˜ì—ì„œ í•„ìˆ˜ì¸ íŒŒë¼ë¯¸í„°ì¸ authOptions: AuthOptions ì˜ ê°’ì´ ë°”ë¡œ NextAuth() í•¨ìˆ˜ì— ë„˜ê²¨ì¤€ ê°’ì´ì—ˆë‹¤.</p>
<p>ê·¸ëŸ¬ë‹ˆê¹Œ const authOptions = {} ê³¼ ê°™ì´ ê°’ì´ ì„¤ì •í•´ ì£¼ê³ ,</p>
<pre><code class="language-ts">const handler = NextAuth(authOptions) 
</code></pre>
<p>ì™€ ê°™ì´ ë„˜ê²¨ì£¼ë©´ ë˜ëŠ” ê±°ì˜€ë‹¤.</p>
<p>ì´ë ‡ê²Œ ìˆ˜ì •í•œ ë²„ì „ì´ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts

import NextAuth from 'next-auth/next'
import CredentialsProvider from 'next-auth/providers/credentials'
import DBMan, { SMember } from '@/app/lib/db';
import { AuthOptions } from 'next-auth';

export const authOptions: AuthOptions = {
  providers: [
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        username: { label: 'ì•„ì´ë””', type: 'text', placeholder: 'ì•„ì´ë”” ì…ë ¥' },
        password: { label: 'ë¹„ë°€ë²ˆí˜¸', type: 'password', placeholder: 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥' },
      },

      async authorize(credentials, req) {
          const db = new DBMan();
          // console.log("credentials?.username", credentials?.username || "");
          // console.log("credentials?.password", credentials?.password || "");
          const member: SMember = await db.login(credentials?.username || "", credentials?.password || "")
          db.disconnect();
  
          console.log("[login] member: ", member);       
          
          if (member != null)
          {
            console.log("[login]ë¡œê·¸ì¸ ì„±ê³µ. member: ", member);       
            return member;    // ë¡œê·¸ì¸ ì„±ê³µ
          }
          else          
          {
            console.log("[login] ë¡œê·¸ì¸ ì‹¤íŒ¨: ", credentials?.username);
            return null;  // ë¡œê·¸ì¸ ì‹¤íŒ¨
          }
      },
    }),
  ] 

  , pages: 
  {
      signIn: '/auth/signin', // Displays signin buttons
      // signOut: '/auth/signout', // Displays form with sign out button
      // error: '/auth/error', // Error code passed in query string as ?error=
      // verifyRequest: '/auth/verify-request', // (used for check email message)
      // newUser: null, // Will disable the new account creation screen
  }
  
  , callbacks: 
  {
      jwt({ token, user }) 
      {
          console.log("\n\n");
          console.log("------------------- [jwt callback] -------------------");
          console.log("[jwt] token = ", token, "\n");
          console.log("[jwt] user = ", user);

          if (user) 
          {
              token.id = user.id;
              token.nickname = user.nickname;
              token.email = user.email;
          }
          
          return token;
      }

      , async session({ session, token }) 
      {
        console.log("\n\n");
        console.log("------------------- [session] -------------------");
        console.log("[session] session = ", session);
        console.log("[session] token = ", token);

        session.user = {
          id : token.id as string,
          nickname: token.nickname as string,
        };
        
        return session;
      }
  }
};

const handler = NextAuth(authOptions)
  
export { handler as GET, handler as POST }
</code></pre>
<p>ì´ê²ƒë§Œìœ¼ë¡œëŠ” ì•„ì§ getServerSession() í•¨ìˆ˜ê°€ ì •ìƒë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤. JWTê°€ ì„œëª…í•˜ê¸° ìœ„í•´ í•„ìš”í•œ í‚¤ë¥¼ ì…ë ¥í•´ ì¤˜ì•¼ í•œë‹¤.</p>
<p>ì›ë¦¬ë¥¼ ì•Œê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ë™ìœ¼ë¡œ í•  ìˆ˜ë„ ìˆì§€ë§Œ <a href="./nextauth_001.html#%EC%9E%90%EB%8F%99%EC%9C%BC%EB%A1%9C-envlocal-%ED%8C%8C%EC%9D%BC-%EB%A7%8C%EB%93%A4%EA%B8%B0%EC%B6%94%EC%B2%9C">ìë™ìœ¼ë¡œ í•˜ëŠ” ê±¸</a> ì¶”ì²œí•œë‹¤.</p>
<h4 id="ìˆ˜ë™ìœ¼ë¡œ-env-íŒŒì¼-ë§Œë“¤ê¸°ë¹„ì¶”"><a class="header" href="#ìˆ˜ë™ìœ¼ë¡œ-env-íŒŒì¼-ë§Œë“¤ê¸°ë¹„ì¶”">ìˆ˜ë™ìœ¼ë¡œ .env íŒŒì¼ ë§Œë“¤ê¸°(ë¹„ì¶”)</a></h4>
<p>í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë”(D:\test\nextauth001\src\nextauth)ì— <code>.env</code> íŒŒì¼ì„ í•˜ë‚˜ ìƒì„±í•˜ê³ , ê·¸ íŒŒì¼ì— ë‹¤ìŒê³¼ ê°™ì´ ì ëŠ”ë‹¤.</p>
<pre><code class="language-ts">// í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë” / .env

NEXTAUTH_SECRET=asdflkajweofjaweofawjawofj902384fawoeijfawoefjq2398fjsadffj0234jfalweka
</code></pre>
<h4 id="ìë™ìœ¼ë¡œ-envlocal-íŒŒì¼-ë§Œë“¤ê¸°ì¶”ì²œ"><a class="header" href="#ìë™ìœ¼ë¡œ-envlocal-íŒŒì¼-ë§Œë“¤ê¸°ì¶”ì²œ">ìë™ìœ¼ë¡œ .env.local íŒŒì¼ ë§Œë“¤ê¸°(ì¶”ì²œ)</a></h4>
<p>ì¶œì²˜: <a href="https://authjs.dev/getting-started/installation#setupenvirontment" title="" target="_blank">https://authjs.dev/getting-started/installation</a></p>
<p>ìœ„ì— ìˆ˜ë™ìœ¼ë¡œ ë§Œë“œëŠ” ê±°ë‘ (ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì§„) íŒŒì¼ëª…ì´ ë‹¤ë¥¸ ë°ë„ ê°™ì€ ì½”ë“œë¡œ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤.</p>
<p>í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ë‹¤ìŒì„ ì‹¤í–‰í•œë‹¤.</p>
<pre><code class="language-ps">npx auth secret
</code></pre>
<p>ì‹¤ì œ ì‹¤í–‰ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<pre><code class="language-ps">PS E:\test\nextauth001\src\nextauth&gt; npx auth secret
Need to install the following packages:
auth@1.2.3
Ok to proceed? (y) y

ğŸ“ Created E:\test\nextauth001\src\nextauth\.env.local with `AUTH_SECRET`.
PS E:\github-stuousk\nextauth001\src\nextauth&gt;
</code></pre>
<p>ë§Œë“¤ì–´ì§„ <code>.env.local</code> íŒŒì¼ì˜ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<pre><code>AUTH_SECRET="KFcZVCNUH3bAJBRXRVhJLx9Gp0qTb2eZheErE6Exy8A=" # Added by `npx auth`. Read more: https://cli.authjs.dev
</code></pre>
<p>next.jsë¥¼ ì²˜ìŒ ë§Œë“¤ë©´ .gitignoreì— <code>.env*</code>ì´ í¬í•¨ë˜ì–´ ìˆë‹¤. ê·¸ë˜ì„œ gitì— ì˜¬ë¼ê°€ì§€ ì•ŠëŠ”ê²Œ ê¸°ë³¸ì´ë‹¤.</p>
<pre><code class="language-txt"># env files (can opt-in for committing if needed)
.env*
</code></pre>
<p>ê·¸ë˜ë„ <code>git status</code> ë“±ì„ í†µí•´ ì´ê²Œ í˜¹ì‹œ git ì„œë²„ë¡œ ì˜¬ë¼ê°€ì§€ëŠ” ì•ŠëŠ”ì§€ í™•ì¸í•´ì•¼ í•œë‹¤.
ì € í‚¤ëŠ” JWT ì„œëª…í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í‚¤ë¼ ì™¸ë¶€ë¡œ ë‚˜ê°€ë©´ ì•ˆ ëœë‹¤.</p>
<h4 id="ë§Œë“¤ì–´ì§„-í‚¤-ì‚¬ìš©í•˜ê¸°"><a class="header" href="#ë§Œë“¤ì–´ì§„-í‚¤-ì‚¬ìš©í•˜ê¸°">ë§Œë“¤ì–´ì§„ í‚¤ ì‚¬ìš©í•˜ê¸°</a></h4>
<p>ìë™ìœ¼ë¡œ ë§Œë“¤ì—ˆê±´ ìˆ˜ë™ìœ¼ë¡œ ë§Œë“¤ì—ˆê±´ ì´ í‚¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ app/api/auth/[â€¦nextauth]/route.ts íŒŒì¼ì˜ authOptionsì— ì¶”ê°€í•´ì•¼ í•œë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts

, secret: process.env.NEXTAUTH_SECRET
</code></pre>
<p>ë¥¼ ì¶”ê°€í•œë‹¤.</p>
<p>ì—¬ê¸°ê¹Œì§€ í•œ ì „ì²´ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts

import NextAuth from 'next-auth/next'
import CredentialsProvider from 'next-auth/providers/credentials'
import DBMan, { SMember } from '@/app/lib/db';
import { AuthOptions } from 'next-auth';

export const authOptions: AuthOptions = {
  providers: [
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        username: { label: 'ì•„ì´ë””', type: 'text', placeholder: 'ì•„ì´ë”” ì…ë ¥' },
        password: { label: 'ë¹„ë°€ë²ˆí˜¸', type: 'password', placeholder: 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥' },
      },

      async authorize(credentials, req) {
          const db = new DBMan();
          // console.log("credentials?.username", credentials?.username || "");
          // console.log("credentials?.password", credentials?.password || "");
          const member: SMember = await db.login(credentials?.username || "", credentials?.password || "")
          db.disconnect();
  
          console.log("[login] member: ", member);       
          
          if (member != null)
          {
            console.log("[login]ë¡œê·¸ì¸ ì„±ê³µ. member: ", member);       
            return member;    // ë¡œê·¸ì¸ ì„±ê³µ
          }
          else          
          {
            console.log("[login] ë¡œê·¸ì¸ ì‹¤íŒ¨: ", credentials?.username);
            return null;  // ë¡œê·¸ì¸ ì‹¤íŒ¨
          }
      },
    }),
  ]
  
  , secret: process.env.NEXTAUTH_SECRET

  , pages: 
  {
      signIn: '/auth/signin', // Displays signin buttons
      // signOut: '/auth/signout', // Displays form with sign out button
      // error: '/auth/error', // Error code passed in query string as ?error=
      // verifyRequest: '/auth/verify-request', // (used for check email message)
      // newUser: null, // Will disable the new account creation screen
  }
  
  , callbacks: 
  {
      jwt({ token, user }) 
      {
          console.log("\n\n");
          console.log("------------------- [jwt callback] -------------------");
          console.log("[jwt] token = ", token, "\n");
          console.log("[jwt] user = ", user);

          if (user) 
          {
              token.id = user.id;
              token.nickname = user.nickname;
              token.email = user.email;
          }
          
          return token;
      }

      , async session({ session, token }) 
      {
        console.log("\n\n");
        console.log("------------------- [session] -------------------");
        console.log("[session] session = ", session);
        console.log("[session] token = ", token);

        session.user = {
          id : token.id as string,
          nickname: token.nickname as string,
        };
        
        return session;
      }
  }
};

const handler = NextAuth(authOptions)
  
export { handler as GET, handler as POST }
</code></pre>
<p>ì´ì œ ë‹¤ì‹œ app/api/data/route.ts íŒŒì¼ì„ ìˆ˜ì •í•´ ìœ„ì— ìˆ˜ì •í•œ authOptionsë¥¼ getServerSession() í•¨ìˆ˜ì— íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸°ë„ë¡ í•´ë³´ì.</p>
<pre><code class="language-ts">import { NextRequest, NextResponse } from 'next/server';
import DBMan from '@/app/lib/db';

import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

export async function GET(req: NextRequest) 
{  
    console.log("authOptions: ", authOptions);
    console.log("process.env.NEXTAUTH_SECRET: ", process.env.NEXTAUTH_SECRET);
    
    const session = await getServerSession(authOptions);
    console.log("\n\n[data/route.ts] session = ", session, "\n");

    const db = new DBMan();
    const data = await db.getData();
    db.disconnect();

    return NextResponse.json(data);
}
</code></pre>
<p>ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì. ê·¸ë¦¬ê³  <code>http://localhost:3000/api/data</code>ì— ì ‘ì†í•œë‹¤.</p>
<p>ì´ì œ ë¡œê·¸ë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì„œë²„ì—ì„œë„ ê°’ì„ ì œëŒ€ë¡œ ê°€ì ¸ì˜¤ê³  ìˆë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.</p>
<pre><code class="language-ps">authOptions:  {
  providers: [
    {
      id: 'credentials',
      name: 'Credentials',
      type: 'credentials',
      credentials: [Object],
      authorize: [Function: authorize],
      options: [Object]
    }
  ],
  secret: 'asdflkajweofjaweofawjawofj902384fawoeijfawoefjq2398fjsadffj0234jfalweka',
  pages: { signIn: '/auth/signin' },
  callbacks: { jwt: [Function: jwt], session: [AsyncFunction: session] }
}
process.env.NEXTAUTH_SECRET:  asdflkajweofjaweofawjawofj902384fawoeijfawoefjq2398fjsadffj0234jfalweka



------------------- [jwt callback] -------------------
[jwt] token =  {
  email: 'test@gmail.com',
  sub: 'user01',
  id: 'user01',
  nickname: 'nickname01',
  iat: 1746779367,
  exp: 1749371367,
  jti: 'b057cd20-d9e4-4df6-880a-cb4c3b619be7'
}

[jwt] user =  undefined



------------------- [session] -------------------
[session] session =  {
  user: { name: undefined, email: 'test@gmail.com', image: undefined },
  expires: '2025-06-08T08:29:32.449Z'
}
[session] token =  {
  email: 'test@gmail.com',
  sub: 'user01',
  id: 'user01',
  nickname: 'nickname01',
  iat: 1746779367,
  exp: 1749371367,
  jti: 'b057cd20-d9e4-4df6-880a-cb4c3b619be7'
}


[data/route.ts] session =  { user: { id: 'user01', nickname: 'nickname01' } }

connect ì„±ê³µ
[db.ts getData] result.rows =  [ { id: 1, title: 'about next.js' }, { id: 2, title: 'about react' } ]
</code></pre>
<p>ì´ì œ session ê°’ì´ ì—†ìœ¼ë©´ íŠ•ê²¨ë‚´ë©´ ëœë‹¤.</p>
<pre><code class="language-ts">import { NextRequest, NextResponse } from 'next/server';
import DBMan from '@/app/lib/db';

import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

export async function GET(req: NextRequest) 
{      
    const session = await getServerSession(authOptions);
    console.log("\n\n[data/route.ts] session = ", session, "\n");

    if (session)
    {
        const db = new DBMan();
        const data = await db.getData();
        db.disconnect();

        return NextResponse.json(data);
    }
    else
    {
        return NextResponse.json("ê¶Œí•œ ì—†ìŒ");
    }
}
</code></pre>
<p>ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì. ê·¸ë¦¬ê³  <code>http://localhost:3000/api/data</code>ì— ì ‘ì†í•´ ë³´ì.</p>
<pre><code class="language-ps">[data/route.ts] session =  { user: { id: 'user01', nickname: 'nickname01' } }
</code></pre>
<p>ë¡œê·¸ì¸í•˜ë©´ sessionì— ê°’ì´ ì œëŒ€ë¡œ ë“¤ì–´ì˜¨ë‹¤.</p>
<p><img src="img/20250509174300.png" alt="" /></p>
<p>ë¡œê·¸ì•„ì›ƒí•˜ê³  <code>http://localhost:3000/api/data</code>ì— ì ‘ì†í•˜ë©´ ìœ„ì™€ ê°™ì€ ë©”ì‹œì§€ë§Œ ë‚˜ì˜¤ê³  ë°ì´í„°ëŠ” ë³´ì—¬ì£¼ì§€ ì•ŠëŠ”ë‹¤.</p>
<p>getServerSession() í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ JWTì˜ ì„œëª…ë¶€ë¶„ì„ ìë™ìœ¼ë¡œ í™•ì¸í•´ì¤€ë‹¤. ì•”í˜¸í™”í•˜ê³  ë³µí˜¸í™”í•˜ê¸° ìœ„í•´ authOptionsì— NEXTAUTH_SECRET ê°€ í•„ìš”í–ˆë˜ ê²ƒ.</p>
<h2 id="sessionuserì˜-ë°ì´í„°-êµ¬ì¡°-ë³€ê²½"><a class="header" href="#sessionuserì˜-ë°ì´í„°-êµ¬ì¡°-ë³€ê²½">Session.Userì˜ ë°ì´í„° êµ¬ì¡° ë³€ê²½</a></h2>
<p>app/api/auth/[â€¦nextauth]/route.ts íŒŒì¼ì—ì„œ jwt() ì½œë°± í•¨ìˆ˜ ë‚´ì—ì„œ ì•„ë˜ì™€ ê°™ì´ ë‚˜íƒ€ë‚˜ëŠ” ê±¸ ë³¼ ìˆ˜ ìˆë‹¤. typescriptì—ì„œëŠ” ì´ ë¬¸ì œë¥¼ í•´ê²°í•´ì•¼ í•œë‹¤.</p>
<p><img src="img/20250509141949.png" alt="" /></p>
<p>Session.userëŠ” {id, name, email}ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. ê·¸ë˜ì„œ nicknameì´ ì—†ë‹¤ê³  ì €ë ‡ê²Œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë‚˜ì˜¤ëŠ” ê±°ë‹¤.</p>
<p>ì´ ë¬¸ì œëŠ” Session.userì˜ íƒ€ì…ì„ ìƒˆë¡œ ì •ì˜í•´ ì£¼ë©´ ëœë‹¤.</p>
<p>app/types í´ë”ë¥¼ í•˜ë‚˜ ë§Œë“¤ì.</p>
<p>ê·¸ ì•ˆì— next-auth.d.ts íŒŒì¼ì„ ìƒì„±í•˜ì.</p>
<pre><code class="language-ts">// app/types/next-auth.d.ts

import NextAuth from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
        id: string;
        nickname: string;        
        email: string | null;
    }
  }

  // jwt() ì½œë°± í•¨ìˆ˜ì— ë“¤ì–´ê°€ëŠ” user íŒŒë¼ë¯¸í„° êµ¬ì¡° ë³€ê²½
  interface User {
    id: string;
    nickname: string;    
    email: string | null;
  }

}
</code></pre>
<p>ì´ë ‡ê²Œ íƒ€ì…ì„ ì¬ì •ì˜í•´ì£¼ë©´ ëœë‹¤.</p>
<p><img src="img/20250509202909.png" alt="" /></p>
<p>ì´ì œ ë¹¨ê°„ ì¤„ì´ ì—†ì–´ì¡Œë‹¤.</p>
<p><img src="img/20250509203022.png" alt="" /></p>
<p>ìƒˆë¡­ê²Œ ì—¬ê¸°ì— ë¹¨ê°„ ì¤„ì´ ìƒˆë¡œ ìƒê²¼ëŠ”ë°, ì´ê±´ Session.userì— emailì´ ìˆëŠ”ë° ë“¤ì–´ê°€ì§€ ì•Šì•„ì„œ ìƒê¸´ê±°ë‹¤.</p>
<p>ì´ê±°ë§ˆì € ì•ˆë‚˜ì˜¤ê²Œ í•˜ê³  ì‹¶ë‹¤ë©´</p>
<pre><code class="language-ts">email?: string | null;
</code></pre>
<p>ì´ë ‡ê²Œ í•´ì£¼ë©´ ëœë‹¤.</p>
<pre><code class="language-ts">// app/types/next-auth.d.ts

import NextAuth from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
        id: string;
        nickname: string;        
        email?: string | null;
    }
  }

  // jwt() ì½œë°± í•¨ìˆ˜ì— ë“¤ì–´ê°€ëŠ” user íŒŒë¼ë¯¸í„° êµ¬ì¡° ë³€ê²½
  interface User {
    id: string;
    nickname: string;    
    email?: string | null;
  }
}
</code></pre>
<p>ì´ë ‡ê²Œ í•´ì£¼ë©´ ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ëœë‹¤.</p>
<h2 id="providers-ìœ„ì¹˜-ë‹¤ì‹œ-ì¡ê¸°"><a class="header" href="#providers-ìœ„ì¹˜-ë‹¤ì‹œ-ì¡ê¸°">Providers ìœ„ì¹˜ ë‹¤ì‹œ ì¡ê¸°</a></h2>
<p>í˜„ì¬ &lt;Providers&gt; ëŠ” app/page.tsx íŒŒì¼ ë‚´ì— ìˆë‹¤. ì´ê²Œ ì „ì—­ì ìœ¼ë¡œ ë‹¤ ê°ì‹¸ì§€ë ¤ë©´ app/layout.tsx íŒŒì¼ ë‚´ì— ìˆì–´ì•¼ í•œë‹¤.</p>
<p>app/page.tsx íŒŒì¼ ë‚´ì—ì„œ <code>&lt;Providers&gt;</code> ì»´í¼ë„ŒíŠ¸ë¥¼ ì—†ì•¤ë‹¤.</p>
<pre><code class="language-ts">// app/page.tsx

import SignInButton_C from "./login/sign_in_button_c";

export default function Home() {
  return (
    &lt;div&gt;
      nextauth
      &lt;SignInButton_C /&gt;      
    &lt;/div&gt;
  );
}
</code></pre>
<p>ê·¸ë¦¬ê³  app/layout.tsx íŒŒì¼ ë‚´ì—ì„œ <code>&lt;Providers&gt;</code> ì»´í¼ë„ŒíŠ¸ë¡œ {Children}ì„ ê°ì‹¼ë‹¤.</p>
<pre><code class="language-ts">// app/layout.tsx

&lt;Providers&gt;
{children}
&lt;/Providers&gt;
</code></pre>
<h2 id="ë¹Œë“œ-ë¬¸ì œ-í•´ê²°"><a class="header" href="#ë¹Œë“œ-ë¬¸ì œ-í•´ê²°">ë¹Œë“œ ë¬¸ì œ í•´ê²°</a></h2>
<p>ì´ì œ ë‹¤ ì™„ì„±í–ˆë‹¤ ìƒê°í•˜ê³ </p>
<pre><code class="language-ps">npm run build
</code></pre>
<p>í•˜ë©´ ë§ì€ ì—ëŸ¬ë¥¼ ë³´ê²Œ ëœë‹¤. í•˜ë‚˜ì”© í•´ê²°í•´ ë³´ì.</p>
<pre><code class="language-ps">PS D:\test\nextauth001\src\nextauth&gt; npm run build

&gt; nextauth@0.1.0 build
&gt; next build

   â–² Next.js 15.3.2
   - Environments: .env

   Creating an optimized production build ...
 âœ“ Compiled successfully in 0ms
   Linting and checking validity of types  ...Failed to compile.

.next/types/app/api/auth/[...nextauth]/route.ts:12:13
Type error: Type 'OmitWithTag&lt;typeof import("D:/test/nextauth001/src/nextauth/src/app/api/auth/[...nextauth]/route"), "GET" | "POST" | "HEAD" | "OPTIONS" | "PUT" | "DELETE" | "PATCH" | "config" | ... 7 more ... | "maxDuration", ""&gt;' does not satisfy the constraint '{ [x: string]: never; }'.
  Property 'authOptions' is incompatible with index signature.
    Type 'AuthOptions' is not assignable to type 'never'.

  10 |
  11 | // Check that the entry is a valid entry
&gt; 12 | checkFields&lt;Diff&lt;{
     |             ^
  13 |   GET?: Function
  14 |   HEAD?: Function
  15 |   OPTIONS?: Function
Next.js build worker exited with code: 1 and signal: null
</code></pre>
<p>ì—¬íƒœê¹Œì§€ ì•„ë¬´ ë¬¸ì œì—†ì´ ì˜ ì‘ë™í–ˆëŠ”ë° ì´ ì—ëŸ¬ë¥¼ ì¢‡ë‹¤ë³´ë©´ í™©ë‹¹í•œ ê²°ë¡ ì„ ì–»ê²Œ ëœë‹¤. ìš°ë¦¬ê°€ ì‚¬ìš©í•œ nextauthëŠ” v4ì¸ë° v4ëŠ” app routerë¥¼ ê³µì‹ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ í•œë‹¤.(ìš°ë¦¬ëŠ” app router ì‚¬ìš©)</p>
<p>.next í´ë”ì™€ node_modules í´ë”ë¥¼ ì§€ìš´ í›„ auth.js v5ë¥¼ ì„¤ì¹˜í–ˆìŒ.</p>
<pre><code class="language-ps">npm install next-auth@beta
</code></pre>
<p>ê·¸ëŸ°ë° build í•´ë„ ë˜‘ê°™ì€ ì—ëŸ¬ ë°œìƒí•¨.</p>
<pre><code>.next/types/app/api/auth/[...nextauth]/route.ts:12:13
Type error: Type 'OmitWithTag&lt;typeof import("D:/github_stuousk/nextauth001/src/nextauth/src/app/api/auth/[...nextauth]/route"), "config" | "generateStaticParams" | "revalidate" | "dynamic" | "dynamicParams" | ... 10 more ... | "PATCH", ""&gt;' does not satisfy the constraint '{ [x: string]: never; }'.
  Property 'authOptions' is incompatible with index signature.
    Type 'AuthOptions' is not assignable to type 'never'.

  10 |
  11 | // Check that the entry is a valid entry
&gt; 12 | checkFields&lt;Diff&lt;{
     |             ^
  13 |   GET?: Function
  14 |   HEAD?: Function
  15 |   OPTIONS?: Function
</code></pre>
<p>next-auth v4ì—ì„œ <a href="https://next-auth.js.org/configuration/initialization#route-handlers-app" title="" target="_blank">https://next-auth.js.org/configuration/initialization#route-handlers-app</a> ë¬¸ì„œë¥¼, ì „ì—ëŠ” ê·¸ëƒ¥ ëŒ€ì¶© ë´¤ëŠ”ë° ë‹¤ì‹œ ìì„¸íˆ ë³´ê³  ìˆìŒ.</p>
<p>ë‹¤ì‹œ next-auth v4ë¡œ ëŒë ¤ ë†“ì•˜ìŒ.</p>
<p>ì´ ë¬¸ì œëŠ” app/api/auth/[â€¦nextauth]/route.ts íŒŒì¼ì—ì„œ authOptionsë¥¼ export í•´ì„œ ë²Œì–´ì§„ ë¬¸ì œì˜€ìŒ. ì´ íŒŒì¼ì—ì„œì˜ exportëŠ” GET, POST ë“± HTTP ë©”ì†Œë“œ ê´€ë ¨ í•¸ë“¤ëŸ¬ë§Œ ê°€ëŠ¥í•˜ë‹¤. ê·¸ë˜ì„œ authOptionsëŠ” ë‹¤ë¥¸ íŒŒì¼ì— ì •ì˜í•´ ë†“ê³  ê°€ì ¸ë‹¤ ì“°ê¸°ë¡œ í•¨.</p>
<p>app/api/auth/[â€¦nextauth]/authoption.ts íŒŒì¼ ìƒì„±í•˜ê³  authOptions ë‚´ìš© ëª¨ë‘ ê°€ì ¸ê°€ì„œ export í•˜ê¸°</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/authoption.ts

import CredentialsProvider from 'next-auth/providers/credentials'
import DBMan, { SMember } from '@/app/lib/db';
import { AuthOptions } from 'next-auth';

export const authOptions: AuthOptions = {
  providers: [
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        username: { label: 'ì•„ì´ë””', type: 'text', placeholder: 'ì•„ì´ë”” ì…ë ¥' },
        password: { label: 'ë¹„ë°€ë²ˆí˜¸', type: 'password', placeholder: 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥' },
      },

      async authorize(credentials, req) {
          const db = new DBMan();
          // console.log("credentials?.username", credentials?.username || "");
          // console.log("credentials?.password", credentials?.password || "");
          const member: SMember = await db.login(credentials?.username || "", credentials?.password || "")
          db.disconnect();
  
          console.log("[login] member: ", member);       
          
          if (member != null)
          {
            console.log("[login]ë¡œê·¸ì¸ ì„±ê³µ. member: ", member);       
            return member;    // ë¡œê·¸ì¸ ì„±ê³µ
          }
          else          
          {
            console.log("[login] ë¡œê·¸ì¸ ì‹¤íŒ¨: ", credentials?.username);
            return null;  // ë¡œê·¸ì¸ ì‹¤íŒ¨
          }
      },
    }),
  ]
  , secret: process.env.NEXTAUTH_SECRET

  , pages: 
  {
      signIn: '/auth/signin', // Displays signin buttons
      // signOut: '/auth/signout', // Displays form with sign out button
      // error: '/auth/error', // Error code passed in query string as ?error=
      // verifyRequest: '/auth/verify-request', // (used for check email message)
      // newUser: null, // Will disable the new account creation screen
  }
  
  , callbacks: 
  {
      jwt({ token, user }) 
      {
          console.log("\n\n");
          console.log("------------------- [jwt callback] -------------------");
          console.log("[jwt] token = ", token, "\n");
          console.log("[jwt] user = ", user);

          if (user) 
          {
              token.id = user.id;
              token.nickname = user.nickname;
              token.email = user.email;
          }
          
          return token;
      }

      , async session({ session, token }) 
      {
        console.log("\n\n");
        console.log("------------------- [session] -------------------");
        console.log("[session] session = ", session);
        console.log("[session] token = ", token);

        session.user = {
          id : token.id as string,
          nickname: token.nickname as string,
        };
        
        return session;
      }
  }
};
</code></pre>
<p>app/api/auth/[â€¦nextauth]/route.ts íŒŒì¼ ìˆ˜ì •ë³¸</p>
<pre><code class="language-ts">// app/api/auth/[...nextauth]/route.ts

import NextAuth from 'next-auth/next'
import { authOptions } from './authoption';

const handler = NextAuth(authOptions)
  
export { handler as GET, handler as POST }
</code></pre>
<p>ê·¸ë¦¬ê³  app/api/data/route.ts íŒŒì¼ë„ authOptions import í•˜ëŠ” ë¶€ë¶„ì„ ìˆ˜ì •í–ˆë‹¤.</p>
<pre><code class="language-ts">// app/api/data/route.ts
import { authOptions } from '@/app/api/auth/[...nextauth]/authoption';
</code></pre>
<p>ì´ë ‡ê²Œ í–ˆë”ë‹ˆ ë¹Œë“œ í†µê³¼ë˜ì—ˆë‹¤.</p>
<p>ë‹¤ìŒ ë¬¸ì œëŠ”</p>
<pre><code>./src/app/lib/db.ts:17:21
Type error: Cannot find namespace 'pg'.

  15 | class DBMan
  16 | {
&gt; 17 |     private client: pg.Client;
     |                     ^
  18 |
</code></pre>
<p>ì´ ë¬¸ì œë‹¤. ì—­ì‹œë‚˜ pgê°€ ì—†ë‹¤ê³  ë‚˜ì˜¨ë‹¤.</p>
<p>ì „ì— ë¬¸ì œê°€ ìˆì–´ì„œ ë¬¸ì œê°€ ì—†ë„ë¡ ìˆ˜ì •í–ˆì—ˆëŠ”ë° ë‹¤ì‹œ ì—ëŸ¬ê°€ ë‚˜ì˜¨ë‹¤.</p>
<p>ì´ ë¶€ë¶„ì€ ì´ë ‡ê²Œ ìˆ˜ì •í—€ë‹¤.</p>
<pre><code class="language-ts">// app/lib/db.ts

import pg from 'pg';
const {Client} = pg;

class DBMan
{    
    client = new Client();
</code></pre>
<p>ì´ì œëŠ” type ì—ëŸ¬ë§Œ ë‚¨ì•˜ë‹¤.</p>
<p>buildí•  ë•Œ eslintë¥¼ ë¹¼ê³  ì‹¶ìœ¼ë©´,
<code>next.config.ts</code> íŒŒì¼ì„ ìˆ˜ì •í•˜ë©´ ëœë‹¤.</p>
<pre><code class="language-ts">// next.config.ts

import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  eslint: {
    // Warning: This allows production builds to successfully complete even if
    // your project has ESLint errors.
    ignoreDuringBuilds: true,
  }
};

export default nextConfig;
</code></pre>
<p>ì¶”ê°€í•œ ë¶€ë¶„ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<pre><code>eslint: {
    ignoreDuringBuilds: true,
  }
</code></pre>
<p>ê´€ë ¨ ë¬¸ì„œ: <a href="https://nextjs.org/docs/app/api-reference/config/eslint#disabling-rules" title="" target="_blank">https://nextjs.org/docs/app/api-reference/config/eslint#disabling-rules</a></p>

                        </div>
                        <div id="sidetoc">
                            <nav id="pagetoc"></nav>
                        </div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../nextauth/nextauth.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../editorjs/editorjs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../nextauth/nextauth.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../editorjs/editorjs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/pagetoc.js"></script>


    </div>
    </body>
</html>